name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: site

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install mise
        uses: jdx/mise-action@v3
        with:
          working_directory: site

      - name: Install dependencies
        run: npm ci

      - name: Run Biome lint
        run: mise run lint

      - name: Run markdownlint
        run: mise run lint:md -- 'src/content/blog/**/*.md'

      - name: Run Harper grammar check (blog)
        # TODO: Remove continue-on-error once placeholder Lorem Ipsum content is replaced
        continue-on-error: true
        run: ./scripts/grammar-check.sh src/content/blog/*.md

      - name: Run Harper grammar check (CV)
        # Allow grammar warnings during initial CV content rollout
        continue-on-error: true
        run: ./scripts/grammar-check.sh src/content/cv/experience/*.mdx

  preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: lint
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false
    defaults:
      run:
        working-directory: site

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install mise
        uses: jdx/mise-action@v3
        with:
          working_directory: site

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Upload preview version
        run: npx wrangler versions upload --preview-alias "pr-${{ github.event.pull_request.number }}"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Post preview URL comment
        uses: actions/github-script@v7
        env:
          PREVIEW_URL: https://pr-${{ github.event.pull_request.number }}-hq.diz.workers.dev
          COMMIT_SHA: ${{ github.event.pull_request.head.sha }}
        with:
          script: |
            const { PREVIEW_URL, COMMIT_SHA } = process.env;
            const shortSha = COMMIT_SHA.substring(0, 7);
            const marker = '<!-- cf-preview -->';
            const body = `${marker}
            ## ðŸš€ Preview Ready

            Your changes have been deployed to a preview environment.

            | | |
            |---|---|
            | **Preview URL** | ${PREVIEW_URL} |
            | **Commit** | \`${shortSha}\` |

            > [!NOTE]
            > This preview will be updated on each push to this PR.
            `;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              per_page: 100,
            });
            const existing = comments.find(c => c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
