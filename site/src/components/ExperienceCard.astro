---
import { Icon } from 'astro-icon/components';
import { getTechIcon } from '../consts';

interface Props {
  id: string;
  title: string;
  company: string;
  companyUrl?: string;
  location: string;
  period: string;
  highlights: string;
  description?: string;
  responsibilities?: string[];
  technologies: string[];
}

const {
  id,
  title,
  company,
  companyUrl,
  location,
  period,
  highlights,
  description,
  responsibilities = [],
  technologies,
} = Astro.props;

const maxCollapsedTech = 10;
const hasMoreTech = technologies.length > maxCollapsedTech;
---

<div class="experience-card relative" data-id={id}>
  <!-- Timeline dot -->
  <div class="absolute left-[11px] top-8 w-6 h-6 rounded-full bg-base-100 border-2 border-primary hidden md:flex items-center justify-center z-10">
    <div class="w-2 h-2 rounded-full bg-primary"></div>
  </div>

  <!-- Card -->
  <div
    id={`exp-${id}`}
    class="card bg-base-200 transition-all hover:shadow-lg hover:border-primary/50 md:ml-14 scroll-mt-24 border border-base-300"
  >
    <div class="card-body p-5">
      <!-- Header - clickable to toggle -->
      <div class="experience-header cursor-pointer" role="button" tabindex="0" aria-expanded="false">
        <div class="flex items-start justify-between gap-4">
          <div class="flex-1 space-y-2">
            <h3 class="card-title text-xl md:text-2xl">{title}</h3>
            <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 text-sm">
              {companyUrl ? (
                <a
                  href={companyUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="company-link flex items-center gap-1.5 font-medium text-primary hover:text-primary/80 transition-colors"
                >
                  <Icon name="tabler:building" class="w-4 h-4" />
                  {company}
                </a>
              ) : (
                <span class="flex items-center gap-1.5 font-medium text-primary">
                  <Icon name="tabler:building" class="w-4 h-4" />
                  {company}
                </span>
              )}
              <span class="hidden sm:inline text-base-content/30">•</span>
              <span class="flex items-center gap-1.5 text-base-content/70">
                <Icon name="tabler:map-pin" class="w-4 h-4" />
                {location}
              </span>
              <span class="hidden sm:inline text-base-content/30">•</span>
              <span class="flex items-center gap-1.5 text-base-content/70">
                <Icon name="tabler:calendar" class="w-4 h-4" />
                {period}
              </span>
            </div>
          </div>
          <button
            class="experience-toggle btn btn-ghost btn-sm btn-square shrink-0"
            aria-label="Expand details"
          >
            <Icon name="tabler:chevron-down" class="w-5 h-5 transition-transform duration-200" />
          </button>
        </div>
      </div>

      <!-- Collapsed content (highlights + limited tech) -->
      <div class="experience-collapsed grid grid-rows-[1fr] transition-all duration-200 ease-out mt-4">
        <div class="overflow-hidden">
          <p class="text-sm text-base-content/70 leading-relaxed">{highlights}</p>
          {technologies.length > 0 && (
            <div class="flex flex-wrap gap-2 mt-3">
              {technologies.slice(0, maxCollapsedTech).map((tech) => (
                <div class="tooltip" data-tip={tech}>
                  <span class="badge badge-outline cursor-default aspect-square p-1.5 bg-white">
                    <Icon name={getTechIcon(tech)} class="w-5 h-5 text-black" />
                  </span>
                </div>
              ))}
              {hasMoreTech && (
                <span class="badge badge-outline">
                  +{technologies.length - maxCollapsedTech} more
                </span>
              )}
            </div>
          )}
        </div>
      </div>

      <!-- Expanded content (description + responsibilities + all tech) -->
      <div class="experience-expanded grid grid-rows-[0fr] transition-all duration-200 ease-out mt-0">
        <div class="overflow-hidden">
          {description && (
            <p class="text-sm text-base-content/80 leading-relaxed mb-4">{description}</p>
          )}
          {responsibilities.length > 0 && (
            <ul class="space-y-1.5 text-sm mb-4">
              {responsibilities.map((item) => (
                <li class="flex gap-2 items-start">
                  <span class="text-primary shrink-0 leading-snug">•</span>
                  <span class="leading-snug">{item}</span>
                </li>
              ))}
            </ul>
          )}
          {technologies.length > 0 && (
            <div class="flex flex-wrap gap-2">
              {technologies.map((tech) => (
                <span class="badge badge-primary badge-outline gap-1.5 bg-white">
                  <Icon name={getTechIcon(tech)} class="w-4 h-4 text-black" />
                  {tech}
                </span>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  import { registerExpandCollapseInit } from '../utils/expand-collapse';

  registerExpandCollapseInit({
    containerSelector: '.experience-card',
    headerSelector: '.experience-header',
    toggleSelector: '.experience-toggle',
    collapsedSelector: '.experience-collapsed',
    expandedSelector: '.experience-expanded',
    idAttribute: 'data-id',
    idPrefix: 'exp-',
    margin: 'mt-4',
    companyLinkSelector: '.company-link',
  });
</script>
