---
import { Icon } from 'astro-icon/components';
import { getTechIcon } from '../consts';

interface Role {
  id: string;
  title: string;
  period: string;
  description: string;
  responsibilities?: string[];
  technologies: string[];
}

interface Props {
  id: string;
  title: string;
  company: string;
  companyUrl?: string;
  location: string;
  period: string;
  roles: Role[];
}

const { id, title, company, companyUrl, location, period, roles } = Astro.props;

const maxCollapsedTech = 8;
---

<div class="grouped-experience-card relative" data-id={id}>
  <!-- Timeline dot -->
  <div class="absolute left-[11px] top-8 w-6 h-6 rounded-full bg-base-100 border-2 border-primary hidden md:flex items-center justify-center z-10">
    <div class="w-2 h-2 rounded-full bg-primary"></div>
  </div>

  <!-- Card -->
  <div
    id={`exp-${id}`}
    class="card bg-base-200 transition-all hover:shadow-lg hover:border-primary/50 md:ml-14 scroll-mt-24 border border-base-300"
  >
    <div class="card-body p-5">
      <!-- Header -->
      <div class="flex items-start justify-between gap-4 mb-4">
        <div class="flex-1 space-y-2">
          <h3 class="card-title text-xl md:text-2xl">{title}</h3>
          <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 text-sm">
            {companyUrl ? (
              <a
                href={companyUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-1.5 font-medium text-primary hover:text-primary/80 transition-colors"
              >
                <Icon name="tabler:building" class="w-4 h-4" />
                {company}
              </a>
            ) : (
              <span class="flex items-center gap-1.5 font-medium text-primary">
                <Icon name="tabler:building" class="w-4 h-4" />
                {company}
              </span>
            )}
            <span class="hidden sm:inline text-base-content/30">•</span>
            <span class="flex items-center gap-1.5 text-base-content/70">
              <Icon name="tabler:map-pin" class="w-4 h-4" />
              {location}
            </span>
            <span class="hidden sm:inline text-base-content/30">•</span>
            <span class="flex items-center gap-1.5 text-base-content/70">
              <Icon name="tabler:calendar" class="w-4 h-4" />
              {period}
            </span>
          </div>
        </div>
      </div>

      <!-- Roles -->
      <div class="space-y-4">
        {roles.map((role, index) => {
          const hasMoreTech = role.technologies.length > maxCollapsedTech;
          const isLast = index === roles.length - 1;
          return (
            <div
              class="role-card relative pl-4 border-l-2 border-base-300"
              data-role-id={role.id}
            >
              <!-- Role connector dot -->
              <div class="absolute -left-[5px] top-2 w-2 h-2 rounded-full bg-base-300"></div>

              <!-- Role Header - clickable to toggle -->
              <div
                class="role-header cursor-pointer"
                role="button"
                tabindex="0"
                aria-expanded="false"
                id={`role-${role.id}`}
              >
                <div class="flex items-start justify-between gap-4">
                  <div class="flex-1">
                    <h4 class="font-semibold text-lg">{role.title}</h4>
                    <span class="text-sm text-base-content/60 font-mono">{role.period}</span>
                  </div>
                  <button
                    class="role-toggle btn btn-ghost btn-xs btn-square shrink-0"
                    aria-label="Expand details"
                  >
                    <Icon name="tabler:chevron-down" class="w-4 h-4 transition-transform duration-200" />
                  </button>
                </div>
              </div>

              <!-- Collapsed content (description + limited tech) -->
              <div class="role-collapsed grid grid-rows-[1fr] transition-all duration-200 ease-out mt-2">
                <div class="overflow-hidden">
                  <p class="text-sm text-base-content/70 leading-relaxed">{role.description}</p>
                  {role.technologies.length > 0 && (
                    <div class="flex flex-wrap gap-2 mt-3">
                      {role.technologies.slice(0, maxCollapsedTech).map((tech) => (
                        <div class="tooltip" data-tip={tech}>
                          <span class="badge badge-outline cursor-default aspect-square p-1.5 bg-white">
                            <Icon name={getTechIcon(tech)} class="w-5 h-5 text-black" />
                          </span>
                        </div>
                      ))}
                      {hasMoreTech && (
                        <span class="badge badge-outline">
                          +{role.technologies.length - maxCollapsedTech}
                        </span>
                      )}
                    </div>
                  )}
                </div>
              </div>

              <!-- Expanded content (responsibilities + all tech) -->
              <div class="role-expanded grid grid-rows-[0fr] transition-all duration-200 ease-out mt-0">
                <div class="overflow-hidden">
                  {role.responsibilities && role.responsibilities.length > 0 && (
                    <ul class="space-y-1.5 text-sm mb-3">
                      {role.responsibilities.map((item) => (
                        <li class="flex gap-2 items-start">
                          <span class="text-primary shrink-0 leading-snug">•</span>
                          <span class="leading-snug">{item}</span>
                        </li>
                      ))}
                    </ul>
                  )}
                  {role.technologies.length > 0 && (
                    <div class="flex flex-wrap gap-2">
                      {role.technologies.map((tech) => (
                        <span class="badge badge-primary badge-outline gap-1.5 bg-white">
                          <Icon name={getTechIcon(tech)} class="w-4 h-4 text-black" />
                          {tech}
                        </span>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              {!isLast && <div class="mt-4"></div>}
            </div>
          );
        })}
      </div>
    </div>
  </div>
</div>

<script>
  // Store role controllers for hash-based expansion
  const roleControllers: Map<string, { setExpanded: (expand: boolean) => void }> = new Map();
  let controller: AbortController | null = null;
  let initialized = false;

  function initGroupedExperienceCards() {
    // Abort previous listeners before re-initializing
    if (controller) {
      controller.abort();
    }
    controller = new AbortController();
    roleControllers.clear();

    document.querySelectorAll('.grouped-experience-card').forEach((card) => {
      card.querySelectorAll('.role-card').forEach((roleCard) => {
        const header = roleCard.querySelector('.role-header');
        const toggle = roleCard.querySelector('.role-toggle');
        const collapsed = roleCard.querySelector('.role-collapsed');
        const expanded = roleCard.querySelector('.role-expanded');
        const chevron = toggle?.querySelector('svg');
        const roleId = roleCard.getAttribute('data-role-id');

        let isExpanded = false;

        function setExpanded(expand: boolean) {
          isExpanded = expand;
          header?.setAttribute('aria-expanded', String(expand));
          toggle?.setAttribute('aria-label', expand ? 'Collapse details' : 'Expand details');

          if (expand) {
            collapsed?.classList.remove('grid-rows-[1fr]', 'mt-2');
            collapsed?.classList.add('grid-rows-[0fr]', 'mt-0');
            expanded?.classList.remove('grid-rows-[0fr]', 'mt-0');
            expanded?.classList.add('grid-rows-[1fr]', 'mt-2');
            chevron?.classList.add('rotate-180');
          } else {
            collapsed?.classList.remove('grid-rows-[0fr]', 'mt-0');
            collapsed?.classList.add('grid-rows-[1fr]', 'mt-2');
            expanded?.classList.remove('grid-rows-[1fr]', 'mt-2');
            expanded?.classList.add('grid-rows-[0fr]', 'mt-0');
            chevron?.classList.remove('rotate-180');
          }
        }

        function handleToggle(e: Event) {
          e.preventDefault();
          setExpanded(!isExpanded);
        }

        const opts = { signal: controller!.signal };

        header?.addEventListener('click', handleToggle, opts);
        header?.addEventListener('keydown', (e) => {
          if ((e as KeyboardEvent).key === 'Enter' || (e as KeyboardEvent).key === ' ') {
            e.preventDefault();
            handleToggle(e);
          }
        }, opts);

        toggle?.addEventListener('click', (e) => {
          e.stopPropagation();
          handleToggle(e);
        }, opts);

        if (roleId) {
          roleControllers.set(roleId, { setExpanded });
        }
      });
    });

    // Handle hash-based expansion
    const handleHash = () => {
      const hash = window.location.hash.slice(1);
      const roleController = roleControllers.get(hash);
      if (roleController) {
        roleController.setExpanded(true);
        setTimeout(() => {
          document.getElementById(`role-${hash}`)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      }
    };

    handleHash();
    window.addEventListener('hashchange', handleHash, { signal: controller.signal });
  }

  initGroupedExperienceCards();

  if (!initialized) {
    initialized = true;
    document.addEventListener('astro:after-swap', initGroupedExperienceCards);
  }
</script>
