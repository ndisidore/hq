---
import { Icon } from 'astro-icon/components';
import { getTechIcon } from '../consts';

interface Role {
  id: string;
  title: string;
  period: string;
  highlights: string;
  description?: string;
  responsibilities?: string[];
  technologies: string[];
}

interface Props {
  id: string;
  title: string;
  company: string;
  companyUrl?: string;
  location: string;
  period: string;
  roles: Role[];
}

const { id, title, company, companyUrl, location, period, roles } = Astro.props;

const maxCollapsedTech = 8;
---

<div class="grouped-experience-card relative" data-id={id}>
  <!-- Timeline dot -->
  <div class="absolute left-[11px] top-8 w-6 h-6 rounded-full bg-base-100 border-2 border-primary hidden md:flex items-center justify-center z-10">
    <div class="w-2 h-2 rounded-full bg-primary"></div>
  </div>

  <!-- Card -->
  <div
    id={`exp-${id}`}
    class="card bg-base-200 transition-all hover:shadow-lg hover:border-primary/50 md:ml-14 scroll-mt-24 border border-base-300"
  >
    <div class="card-body p-5">
      <!-- Header -->
      <div class="flex items-start justify-between gap-4 mb-4">
        <div class="flex-1 space-y-2">
          <h3 class="card-title text-xl md:text-2xl">{title}</h3>
          <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 text-sm">
            {companyUrl ? (
              <a
                href={companyUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-1.5 font-medium text-primary hover:text-primary/80 transition-colors"
              >
                <Icon name="tabler:building" class="w-4 h-4" />
                {company}
              </a>
            ) : (
              <span class="flex items-center gap-1.5 font-medium text-primary">
                <Icon name="tabler:building" class="w-4 h-4" />
                {company}
              </span>
            )}
            <span class="hidden sm:inline text-base-content/30">•</span>
            <span class="flex items-center gap-1.5 text-base-content/70">
              <Icon name="tabler:map-pin" class="w-4 h-4" />
              {location}
            </span>
            <span class="hidden sm:inline text-base-content/30">•</span>
            <span class="flex items-center gap-1.5 text-base-content/70">
              <Icon name="tabler:calendar" class="w-4 h-4" />
              {period}
            </span>
          </div>
        </div>
      </div>

      <!-- Roles -->
      <div class="relative space-y-4 ml-1">
        <!-- Continuous timeline line -->
        {roles.length > 1 && (
          <div
            class="absolute left-[3px] top-3 w-0.5 bg-primary/30"
            style={`height: calc(100% - 1.5rem);`}
          />
        )}
        {roles.map((role, index) => {
          const hasMoreTech = role.technologies.length > maxCollapsedTech;
          const isLast = index === roles.length - 1;
          return (
            <div
              class="role-card relative pl-4"
              data-role-id={role.id}
            >
              <!-- Role connector dot -->
              <div class="absolute left-0 top-2 w-2 h-2 rounded-full bg-primary/50 border border-primary z-10"></div>

              <!-- Role Header - clickable to toggle -->
              <div
                class="role-header cursor-pointer"
                role="button"
                tabindex="0"
                aria-expanded="false"
                id={`role-${role.id}`}
              >
                <div class="flex items-start justify-between gap-4">
                  <div class="flex-1">
                    <h4 class="font-semibold text-lg">{role.title}</h4>
                    <span class="text-sm text-base-content/60 font-mono">{role.period}</span>
                  </div>
                  <button
                    class="role-toggle btn btn-ghost btn-xs btn-square shrink-0"
                    aria-label="Expand details"
                  >
                    <Icon name="tabler:chevron-down" class="w-4 h-4 transition-transform duration-200" />
                  </button>
                </div>
              </div>

              <!-- Collapsed content (highlights + limited tech) -->
              <div class="role-collapsed grid grid-rows-[1fr] transition-all duration-200 ease-out mt-2">
                <div class="overflow-hidden">
                  <p class="text-sm text-base-content/70 leading-relaxed">{role.highlights}</p>
                  {role.technologies.length > 0 && (
                    <div class="flex flex-wrap gap-2 mt-3">
                      {role.technologies.slice(0, maxCollapsedTech).map((tech) => (
                        <div class="tooltip" data-tip={tech}>
                          <span class="badge badge-outline cursor-default aspect-square p-1.5 bg-white">
                            <Icon name={getTechIcon(tech)} class="w-5 h-5 text-black" />
                          </span>
                        </div>
                      ))}
                      {hasMoreTech && (
                        <span class="badge badge-outline">
                          +{role.technologies.length - maxCollapsedTech}
                        </span>
                      )}
                    </div>
                  )}
                </div>
              </div>

              <!-- Expanded content (description + responsibilities + all tech) -->
              <div class="role-expanded grid grid-rows-[0fr] transition-all duration-200 ease-out mt-0">
                <div class="overflow-hidden">
                  {role.description && (
                    <p class="text-sm text-base-content/80 leading-relaxed mb-3">{role.description}</p>
                  )}
                  {role.responsibilities && role.responsibilities.length > 0 && (
                    <ul class="space-y-1.5 text-sm mb-3">
                      {role.responsibilities.map((item) => (
                        <li class="flex gap-2 items-start">
                          <span class="text-primary shrink-0 leading-snug">•</span>
                          <span class="leading-snug">{item}</span>
                        </li>
                      ))}
                    </ul>
                  )}
                  {role.technologies.length > 0 && (
                    <div class="flex flex-wrap gap-2">
                      {role.technologies.map((tech) => (
                        <span class="badge badge-primary badge-outline gap-1.5 bg-white">
                          <Icon name={getTechIcon(tech)} class="w-4 h-4 text-black" />
                          {tech}
                        </span>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              {!isLast && <div class="mt-4"></div>}
            </div>
          );
        })}
      </div>
    </div>
  </div>
</div>

<script>
  import { registerExpandCollapseInit } from '../utils/expand-collapse';

  registerExpandCollapseInit({
    containerSelector: '.grouped-experience-card .role-card',
    headerSelector: '.role-header',
    toggleSelector: '.role-toggle',
    collapsedSelector: '.role-collapsed',
    expandedSelector: '.role-expanded',
    idAttribute: 'data-role-id',
    idPrefix: 'role-',
    margin: 'mt-2',
  });
</script>
