---
import { getCollection } from 'astro:content';
import { Icon } from 'astro-icon/components';
import BaseHead from '../components/BaseHead.astro';
import ExperienceCard from '../components/ExperienceCard.astro';
import Footer from '../components/Footer.astro';
import GroupedExperienceCard from '../components/GroupedExperienceCard.astro';
import Header from '../components/Header.astro';
import SkillRadar from '../components/SkillRadar.astro';
import { getTechIcon, SITE_TITLE } from '../consts';
import {
  parseGroupedExperienceContent,
  parseSingleExperienceContent,
} from '../utils/mdx-sections';

// Fetch and sort experience entries (higher order = more recent)
const experienceEntries = (await getCollection('experience')).sort(
  (a, b) => b.data.order - a.data.order,
);

// Process each entry to extract content sections from MDX body
const processedExperience = experienceEntries.map((entry) => {
  const { data, body } = entry;

  if (data.type === 'grouped' && data.roles) {
    // Parse grouped experience - extract per-role content from MDX body
    const roleContent = parseGroupedExperienceContent(body || '');

    const processedRoles = data.roles.map((role) => ({
      ...role,
      highlights: roleContent[role.id]?.highlights || '',
      description: roleContent[role.id]?.description || '',
      responsibilities: roleContent[role.id]?.details || [],
    }));

    return {
      type: 'grouped' as const,
      id: data.id,
      title: data.title,
      company: data.company,
      companyUrl: data.companyUrl,
      location: data.location,
      period: data.period,
      roles: processedRoles,
    };
  }

  // Parse single experience
  const content = parseSingleExperienceContent(body || '');

  return {
    type: 'single' as const,
    id: data.id,
    title: data.title,
    company: data.company,
    companyUrl: data.companyUrl,
    location: data.location,
    period: data.period,
    highlights: content.highlights,
    description: content.description,
    responsibilities: content.details,
    technologies: data.technologies,
  };
});

const education = [
  {
    degree: 'B.S. Computer Engineering',
    institution: 'The University of Kansas',
    location: 'Lawrence, KS',
    period: 'May 2014',
    description:
      "Cumulative GPA: 3.42 / Professional GPA: 3.50. Dean's List (4 semesters). Focus on Circuits, Networks, Programming, Embedded Systems, Operating Systems, and Digital Design.",
  },
];

const speaking = [
  {
    title: 'The Babel Fix: Unifying APIs with Cloudflare Workers and AI',
    event: 'Cloudflare Connect 2025',
    location: 'Las Vegas, NV',
    date: 'October 2025',
    description:
      'Presented strategies for streamlining API integrations using Cloudflare Workers for Platforms and Workflows. Demonstrated how AI-driven automation transforms fragmented API workflows into reliable, intelligent pipelines.',
    presentationUrl: 'https://presentations.diz.rocks/cc25-workers-as-glue',
  },
  {
    title: 'AI on Demand: Serverless AI',
    event: 'DevOps.js Conference',
    location: 'Remote',
    date: 'February 2024',
    description:
      'Delivered a hands-on workshop exploring serverless architecture applications in AI. Guided participants through building a RAG application using Workers AI, Vectorize, D1, and Cloudflare Workers.',
  },
];

const skills = {
  Languages: ['Golang', 'Python', 'Rust', 'TypeScript', 'C/C++', 'Ruby'],
  'Web & Frontend': ['React', 'Node.js', 'GraphQL', 'TanStack', 'Redux'],
  'Cloud & DevOps': [
    'AWS',
    'Kubernetes',
    'Docker',
    'Terraform',
    'Cloudflare Workers',
    'GitHub Actions',
  ],
  'Databases & Streaming': [
    'PostgreSQL',
    'DynamoDB',
    'Redis',
    'Kafka',
    'ClickHouse',
    'DuckDB',
  ],
  Observability: ['Prometheus', 'Grafana', 'OpenTelemetry', 'VictoriaMetrics'],
  'IoT & Edge': [
    'Computer Vision',
    'GPU Acceleration',
    'Temporal',
    'Ansible',
    'AXIS ACAP',
  ],
};

const expertise = [
  { label: 'Systems Programming', value: 90 },
  { label: 'Cloud & DevOps', value: 95 },
  { label: 'Distributed Systems', value: 90 },
  { label: 'Data Engineering', value: 70 },
  { label: 'AI & ML', value: 75 },
  { label: 'Frontend & Web', value: 75 },
  { label: 'IoT & Embedded', value: 65 },
  { label: 'Observability & SRE', value: 85 },
];
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={`CV | ${SITE_TITLE}`} description="My professional experience and skills" />
  </head>
  <body class="min-h-screen flex flex-col">
    <Header />
    <main class="container mx-auto px-4 py-8 max-w-4xl flex-1">
      <h1 class="text-4xl font-bold mb-2">Curriculum Vitae</h1>
      <p class="text-base-content/70 mb-8">My professional journey and skills</p>

      <!-- Experience Section -->
      <section class="mb-12">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <Icon name="tabler:briefcase" class="h-6 w-6" />
          Experience
        </h2>

        <div class="relative">
          <!-- Timeline line -->
          <div
            class="absolute left-[23px] w-0.5 bg-gradient-to-b from-primary/50 via-primary/30 to-primary/10 hidden md:block"
            style="top: 44px; height: calc(100% - 88px);"
          />

          <div class="space-y-6">
            {
              processedExperience.map((exp) =>
                exp.type === 'grouped' ? (
                  <GroupedExperienceCard
                    id={exp.id}
                    title={exp.title}
                    company={exp.company}
                    companyUrl={exp.companyUrl}
                    location={exp.location}
                    period={exp.period}
                    roles={exp.roles}
                  />
                ) : (
                  <ExperienceCard
                    id={exp.id}
                    title={exp.title}
                    company={exp.company}
                    companyUrl={exp.companyUrl}
                    location={exp.location}
                    period={exp.period}
                    highlights={exp.highlights}
                    description={exp.description}
                    responsibilities={exp.responsibilities}
                    technologies={exp.technologies}
                  />
                )
              )
            }
          </div>
        </div>
      </section>

      <!-- Education Section -->
      <section class="mb-12">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <Icon name="tabler:school" class="h-6 w-6" />
          Education
        </h2>

        <div class="space-y-6">
          {
            education.map((edu) => (
              <div class="card bg-base-200">
                <div class="card-body">
                  <h3 class="card-title text-lg">{edu.degree}</h3>
                  <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-sm">
                    <span class="text-secondary font-semibold">{edu.institution}</span>
                    <span class="text-base-content/60">|</span>
                    <span class="text-base-content/70">{edu.location}</span>
                    <span class="text-base-content/60">|</span>
                    <time class="font-mono italic text-base-content/70">{edu.period}</time>
                  </div>
                  <p class="mt-2 text-base-content/80">{edu.description}</p>
                </div>
              </div>
            ))
          }
        </div>
      </section>

      <!-- Speaking Section -->
      <section class="mb-12">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <Icon name="tabler:microphone" class="h-6 w-6" />
          Speaking & Events
        </h2>

        <div class="space-y-6">
          {
            speaking.map((talk) => (
              <div class="card bg-base-200">
                <div class="card-body">
                  <div class="flex items-start justify-between gap-4">
                    <h3 class="card-title text-lg">{talk.title}</h3>
                    {talk.presentationUrl && (
                      <a
                        href={talk.presentationUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="btn btn-sm btn-ghost gap-1.5 text-primary shrink-0"
                        title="View Slides"
                      >
                        <Icon name="tabler:presentation" class="h-5 w-5" />
                        <span class="hidden sm:inline">Slides</span>
                      </a>
                    )}
                  </div>
                  <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-sm">
                    <span class="text-primary font-semibold">{talk.event}</span>
                    <span class="text-base-content/60">|</span>
                    <span class="text-base-content/70">{talk.location}</span>
                    <span class="text-base-content/60">|</span>
                    <time class="font-mono italic text-base-content/70">{talk.date}</time>
                  </div>
                  <p class="mt-2 text-base-content/80">{talk.description}</p>
                </div>
              </div>
            ))
          }
        </div>
      </section>

      <!-- Expertise Section -->
      <section class="mb-12">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <Icon name="tabler:chart-radar" class="h-6 w-6" />
          Expertise
        </h2>

        <div class="card bg-base-200">
          <div class="card-body items-center">
            <SkillRadar skills={expertise} title="" />
          </div>
        </div>
      </section>

      <!-- Skills Section -->
      <section>
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <Icon name="tabler:bulb" class="h-6 w-6" />
          Skills
        </h2>

        <div class="grid md:grid-cols-2 gap-6">
          {
            Object.entries(skills).map(([category, skillList]) => (
              <div class="card bg-base-200">
                <div class="card-body">
                  <h3 class="card-title text-lg">{category}</h3>
                  <div class="flex flex-wrap gap-2">
                    {skillList.map((skill) => (
                      <span class="badge badge-primary badge-outline gap-1.5 bg-white">
                        <Icon name={getTechIcon(skill)} class="w-4 h-4 text-black" />
                        {skill}
                      </span>
                    ))}
                  </div>
                </div>
              </div>
            ))
          }
        </div>
      </section>
    </main>
    <Footer />
  </body>
</html>
